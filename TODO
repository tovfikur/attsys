ATTENDANCE & PAYROLL SAAS PLATFORM — MASTER TODO (PM + SOFTWARE ARCHITECT)

Scope summary:
- Frontend: React (polished, responsive UI)
- Backend: Secure vanilla PHP (no framework) JSON API + cron workers
- SaaS multi-tenancy by subdomain
- Superadmin provisions tenant subdomain via Cloudflare DNS API
- Each tenant supports multiple sites and multiple devices (“machines”)

How to use this TODO:
- P0 = must for MVP launch
- P1 = should for first stable release after MVP
- P2 = later improvements
- Each item is written as “done when …”

================================================================================
0) PROJECT SETUP & GOVERNANCE
================================================================================

[P0] Define MVP boundaries and non-goals
  Done when: MVP feature list is locked and signed off.

[P0] Define environments (dev/stage/prod) and release flow
  Done when: a documented deployment path exists and is reproducible.

[P0] Choose tenant isolation strategy (shared DB + tenant_id OR per-tenant DB)
  Done when: decision is documented and drives schema + query rules.

[P0] Define coding standards and repository structure (React + PHP)
  Done when: folder structure is established and lint/format rules exist.

[P0] Define roles and responsibilities (Superadmin, Tenant Owner, HR, Payroll, Manager, Employee)
  Done when: RBAC matrix is agreed and mapped to endpoint permissions.

================================================================================
1) SAAS FOUNDATIONS (MULTI-TENANCY + SUBDOMAIN)
================================================================================

[P0] Implement hostname-based tenant resolution
  Done when: requests resolve tenant from subdomain and unknown tenants are rejected.

[P0] Implement tenant lifecycle states
  States: draft, provisioning, active, provisioning_failed, suspended, deleted(soft)
  Done when: state transitions are enforced server-side and audited.

[P0] Enforce tenant isolation across all tenant data
  Done when: every tenant-owned table includes tenant_id (or isolation alternative),
             and every query is constrained to resolved tenant.

[P0] Implement superadmin portal authentication and authorization
  Done when: superadmin can log in and access only platform routes.

[P0] Implement tenant portal authentication and authorization
  Done when: tenant users can log in only under their tenant subdomain and RBAC works.

[P0] Implement cross-tenant access protections (IDOR prevention)
  Done when: API rejects any attempt to access resources not owned by current tenant.

================================================================================
2) CLOUDFLARE DNS PROVISIONING (SUPERADMIN)
================================================================================

[P0] Define Cloudflare DNS configuration inputs
  Inputs: zone_id, record type (A/CNAME), target, proxy mode, TTL
  Done when: these values are configurable via server environment (not frontend).

[P0] Implement Cloudflare API client (server-side only)
  Done when: backend can create/update/read DNS records using a token stored as secret.

[P0] Implement tenant provisioning workflow (idempotent)
  Done when:
  - creating tenant triggers DNS creation
  - retries do not create duplicate records
  - failure sets provisioning_failed with retriable action

[P0] Implement provisioning audit trail
  Done when: every provisioning attempt stores action, actor, timestamps, and non-secret metadata.

[P1] Implement tenant subdomain change flow (optional, risky)
  Done when: safe migration plan exists and DNS is updated without data loss.

================================================================================
3) SECURITY BASELINE (MANDATORY)
================================================================================

[P0] Implement password hashing and secure authentication
  Done when: passwords are hashed using PHP built-ins (bcrypt/argon2), never logged.

[P0] Implement login rate-limiting and brute-force protections
  Done when: repeated failures are throttled and no user enumeration is leaked.

[P0] Implement session/token strategy and CSRF protections
  Done when: auth cannot be trivially stolen via XSS and CSRF is handled (if cookies used).

[P0] Implement input validation layer for all API endpoints
  Done when: invalid payloads return consistent errors and never reach DB logic.

[P0] Implement prepared statements for all SQL queries
  Done when: no concatenated SQL exists for user-controlled input paths.

[P0] Implement CORS policy (strict)
  Done when: only known origins can call the API in browser context.

[P0] Implement file upload safety (for leave attachments)
  Done when: size/type allowlist exists, files stored outside web root, download is authorized.

[P0] Implement audit logging (tenant + platform)
  Must include: auth events, role changes, overrides, payroll finalize/export, provisioning
  Done when: audit log is queryable per tenant and immutable in normal UI flows.

[P1] Add MFA hooks (optional)
  Done when: design supports enabling MFA per tenant without breaking auth.

================================================================================
4) DATA MODEL & DATABASE
================================================================================

[P0] Create core schema for multi-tenancy and RBAC
  Tables: tenants, tenant_users, roles/permissions (or role enum), audit_logs
  Done when: tenant resolution and RBAC can be enforced using DB records.

[P0] Create organization tables
  Tables: sites, departments, designations, company_settings, holiday_calendar
  Done when: tenant can be configured with timezone/currency and org structure.

[P0] Create employee and device tables
  Tables: employees, employee_identifiers(cardNo), devices, device_sync_status
  Done when: many devices per tenant and many identifiers per employee are supported.

[P0] Create attendance tables
  Tables: raw_events, attendance_days, shift_templates, roster_assignments
  Done when: raw ingestion and processed daily attendance can be stored and recalculated.

[P0] Create leave tables
  Tables: leave_types, leave_policies, leave_requests, leave_attachments
  Done when: leave requests can be approved and reflected in attendance.

[P0] Create payroll tables
  Tables: salary_structures, salary_components, payroll_runs, payslips
  Done when: payroll run can be previewed, finalized, and payslips archived.

================================================================================
5) DEVICE INTEGRATION & INGESTION (“MACHINES”)
================================================================================

[P0] Define device onboarding workflow
  Done when: tenant can add device with site, connection fields, and test connection.

[P0] Implement pull-based device sync worker (cron)
  Done when: events are imported on schedule per device and failures are tracked.

[P0] Implement de-duplication strategy for raw events
  Done when: repeated imports never double count identical events.

[P0] Implement timezone normalization
  Done when: raw events stored in UTC and displayed/processed in tenant timezone.

[P0] Implement mapping of device identifiers to employees
  Done when: attendance processing can link events to employees reliably.

[P1] Implement push/webhook ingestion (if devices support)
  Done when: system accepts signed/secured device pushes and stores raw events.

[P1] Implement CSV import fallback
  Done when: tenant can upload device CSV export and system imports with validation.

================================================================================
6) ATTENDANCE PROCESSING (RULES ENGINE)
================================================================================

[P0] Implement shift templates with grace/break rules
  Done when: shifts store start/end, grace minutes, breaks, late/early thresholds.

[P0] Implement roster assignment per employee per date
  Done when: per-day shift selection is deterministic.

[P0] Implement attendance day generation from raw events
  Default: first-in + last-out; configurable later
  Done when: attendance_days are produced with in_time, out_time, worked_minutes.

[P0] Implement attendance status evaluation
  Status: Present, Absent, Half-day, On Leave, Holiday
  Done when: statuses are correct for typical scenarios and configurable thresholds exist.

[P0] Implement late, early leave, overtime minute calculations
  Done when: late_minutes, early_leave_minutes, overtime_minutes are computed consistently.

[P0] Implement manual correction workflow with mandatory reason + audit
  Done when: authorized roles can correct, changes are tracked, and reports reflect overrides.

[P1] Add recalculation engine (recompute attendance for date range)
  Done when: HR can trigger reprocess after rule changes safely.

================================================================================
7) LEAVE MANAGEMENT
================================================================================

[P0] Implement leave types and basic leave policy per tenant
  Done when: tenant can define leave types and apply them to employees.

[P0] Implement leave request submission and attachments
  Done when: employee can submit requests and see status.

[P0] Implement approval workflow (manager approve/reject)
  Done when: managers can approve and attendance reflects approved leave automatically.

[P1] Add leave balance tracking and accrual policies
  Done when: balances update automatically and payroll rules can reference balances.

================================================================================
8) PAYROLL & PAYSLIPS
================================================================================

[P0] Implement salary structure per employee (components)
  Done when: base + allowances + deductions exist and can be configured.

[P0] Implement attendance-based adjustments mapping
  Items: absence deduction, late penalty, overtime pay
  Done when: formulas/slabs can be configured and applied per payroll run.

[P0] Implement payroll run lifecycle
  States: draft/preview, validated, finalized, reopened(audited)
  Done when: finalize locks the period and prevents silent changes.

[P0] Implement payslip generation and archive
  Done when: payslips are created per employee and stored for later access.

[P0] Implement payslip PDF export (single + bulk)
  Done when: PDFs are generated reliably and bulk export is role-restricted.

[P1] Add statutory reports hooks (country-specific)
  Done when: architecture supports country modules without core rewrites.

================================================================================
9) FRONTEND (REACT) — POLISHED UI DELIVERY
================================================================================

[P0] Choose UI foundation (design system approach)
  Done when: component library approach is decided and consistent across app.

[P0] Implement app shell and navigation (tenant portal)
  Done when: layout, routes, sidebar/topbar, breadcrumbs, loading states exist.

[P0] Implement superadmin portal UI
  Screens: tenants list, create tenant, provisioning status, retry provisioning
  Done when: superadmin can create tenant end-to-end and see results.

[P0] Implement tenant portal core modules UI
  Modules: employees, devices, shifts/rosters, attendance, leave, payroll, payslips, settings
  Done when: CRUD + list filters + details pages exist for each.

[P0] Implement UX polish
  Done when: empty states, skeleton loaders, toasts, form validation, and error pages exist.

[P0] Implement responsiveness and accessibility baseline
  Done when: mobile works for employee self-service and keyboard navigation is usable.

[P1] Add analytics dashboard visuals (charts)
  Done when: key KPIs are shown with performant charting and good empty/loading states.

================================================================================
10) OBSERVABILITY, OPERATIONS, AND RELIABILITY
================================================================================

[P0] Implement health checks
  Done when: app has endpoints for basic health and worker/job health.

[P0] Implement job monitoring and failure visibility
  Done when: superadmin can see provisioning failures and device sync failure summaries.

[P0] Implement backup strategy and restore rehearsal
  Done when: backups run automatically and restore procedure is tested.

[P0] Implement log hygiene
  Done when: logs are structured, searchable, and do not contain secrets/PII unnecessarily.

[P1] Implement rate limiting on key endpoints (beyond login)
  Done when: abuse is mitigated for heavy endpoints (exports, imports).

================================================================================
11) TESTING, QA, AND ACCEPTANCE
================================================================================

[P0] Define acceptance test plan aligned to requirements
  Done when: pass/fail criteria exist for SaaS provisioning, isolation, payroll integrity.

[P0] Create automated tests for tenant isolation and RBAC
  Done when: regression suite catches cross-tenant data leaks.

[P0] Create automated tests for provisioning idempotency
  Done when: repeated tenant creation attempts behave safely.

[P0] Create automated tests for attendance processing edge cases
  Done when: multi-punch, missing punch, grace, holidays, leave behave as expected.

[P0] Create automated tests for payroll finalization locking
  Done when: finalized runs cannot be mutated without audited reopen.

[P0] Run security review checklist
  Done when: OWASP basics reviewed (auth, CSRF, XSS, SQLi, uploads, CORS).

================================================================================
12) DEPLOYMENT & LAUNCH
================================================================================

[P0] Prepare production configuration and secrets management
  Done when: Cloudflare token and DB credentials are stored securely (not in repo).

[P0] Prepare domain + wildcard TLS strategy
  Done when: subdomains can serve HTTPS reliably (wildcard certificate or equivalent).

[P0] Launch checklist and rollback plan
  Done when: release can be rolled back safely and data migrations are controlled.

[P1] Onboarding guides and in-app onboarding (optional)
  Done when: tenant admin can onboard employees/devices with minimal support.

================================================================================
MILESTONES (RECOMMENDED)
================================================================================

Milestone M0 (Foundation):
- Tenant resolution + RBAC skeleton + DB schema baseline + auth + audit log

Milestone M1 (SaaS Provisioning):
- Superadmin portal + Cloudflare DNS provisioning + tenant activation

Milestone M2 (Attendance Core):
- Devices + ingestion worker + raw events + attendance day processing + corrections

Milestone M3 (Leave + Payroll MVP):
- Leave requests/approvals + payroll run preview/finalize + payslips PDF

Milestone M4 (Hardening):
- Isolation tests, security hardening, monitoring, backups, performance tuning

