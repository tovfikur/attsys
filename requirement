# Attendance & Payroll SaaS Platform — Requirements

**Frontend:** React (beautiful UI)  
**Backend:** Secure vanilla PHP (no framework)  
**SaaS:** Multi-tenant by subdomain + Cloudflare DNS automation  
**Devices:** Each tenant supports multiple sites and multiple machines/devices

---

## 1. Purpose

Build a production-ready SaaS platform that collects attendance data from devices (e.g., Hikvision), processes it using configurable HR rules (shifts, grace, late, absence, overtime, holidays, leave), and generates payroll runs and printable payslips.

Each customer company is a **tenant** accessed via its own subdomain (e.g., `acme.example.com`). A tenant may have multiple locations and many attendance machines/devices.

---

## 2. Stakeholders

- Superadmin (SaaS operator)
- Tenant Owner (company administrator)
- HR Admin
- Payroll Admin
- Manager (approver)
- Employee
- IT / Device onboarding admin
- Finance

---

## 3. SaaS Multi-tenancy (Mandatory)

### 3.1 Tenant Identification (Subdomain)

- Each tenant has a unique subdomain: `{tenantSubdomain}.{baseDomain}`
- Reserved subdomains must be blocked: `www`, `admin`, `api`, `superadmin`, `mail`, `ftp`, `dev`, `test`, `staging`
- Subdomain format: lowercase, `[a-z0-9-]`, length limits enforced

### 3.2 Tenant Resolution (Routing)

- Hostname determines the tenant:
  - `superadmin.{baseDomain}` → superadmin portal
  - `{tenantSubdomain}.{baseDomain}` → tenant portal
- If hostname is unknown or tenant is not active: deny access

### 3.3 Tenant Isolation (Data Safety)

- Tenant data must be isolated at the backend layer.
- All tenant-owned tables must include `tenant_id` (or an equivalent per-tenant database approach).
- Every query must be constrained to the resolved tenant.
- Direct object references must be validated by tenant ownership.

---

## 4. Tenant Provisioning via Cloudflare DNS (Mandatory)

### 4.1 Provisioning Workflow

When Superadmin creates a tenant:

1. Validate requested subdomain and tenant metadata
2. Create tenant record with status `provisioning`
3. Call Cloudflare API to create DNS record:
   - Record type: `CNAME` or `A` (configurable)
   - Name: `{tenantSubdomain}`
   - Target: SaaS edge hostname or IP (configurable)
   - TTL: auto or configured
   - Proxy: configurable
4. Verify record exists (read-after-write)
5. Mark tenant `active`
6. Create initial tenant admin invitation

If Cloudflare fails:

- Tenant becomes `provisioning_failed`
- Retry must be safe (idempotent, no duplicate records)

### 4.2 Cloudflare Security

- Cloudflare token is server-side only (environment/secret store)
- Token must never be returned to the frontend
- Provisioning actions must be audited (without secrets)

---

## 5. Roles & Permissions (RBAC)

### 5.1 Platform Role

- **Superadmin**: manage tenants, provisioning, platform health, global settings

### 5.2 Tenant Roles (Minimum)

- **Tenant Owner**: full tenant configuration and user management
- **HR Admin**: employees, shifts, rosters, attendance rules, leave policy
- **Payroll Admin**: salary structures, payroll runs, payslips, exports
- **Manager**: approvals and team visibility (limited salary access)
- **Employee**: self-service (attendance, leave, payslips)

Requirements:

- All permissions must be enforced server-side on every endpoint.
- Users belong to exactly one tenant in Phase 1.

---

## 6. Functional Requirements (Tenant)

### 6.1 Organization Setup

- Company profile: name, address, timezone, currency
- Sites/locations management
- Departments and designations
- Holiday calendar management

### 6.2 Employee Management

- Create, update, deactivate employees
- Employee fields (minimum):
  - employee_code, name, department, designation, join date, status
  - contact info (email/phone)
  - identifiers (one or more card numbers)
- Bulk import/export employees (CSV)

### 6.3 Device (“Machine”) Management (Multi-device)

- Register/manage many devices per tenant
- Device fields (minimum):
  - name, site, model, IP/hostname, connection settings, status, last_sync_at
- Map device identifiers (cardNo/userId) to employees
- Device health:
  - last sync time, last error, offline detection, alerts

### 6.4 Attendance Ingestion (Hikvision and Others)

- Import modes:
  - Pull sync (scheduled)
  - Push/webhook (if supported)
  - CSV upload fallback
- Data fields to capture (minimum):
  - tenant_id, device_id, occurred_at_utc, identifier (cardNo), event_type, raw_payload
- De-duplication required (same event imported multiple times must not duplicate)
- Time handling:
  - store in UTC
  - convert to tenant timezone for UI and rules

### 6.5 Shifts & Rosters

- Define shift templates:
  - start/end time, grace minutes, break windows, paid/unpaid breaks
  - late and early leave thresholds
- Assign rosters to employees by date range

### 6.6 Attendance Processing

- Produce per-employee attendance days:
  - first-in / last-out default, configurable multi-punch logic
- Status rules (minimum):
  - Present, Absent, Half-day, On Leave, Holiday
- Computed fields:
  - worked_minutes, late_minutes, early_leave_minutes, overtime_minutes
- Manual correction flow:
  - authorized users can override in/out times
  - reason required
  - all overrides audited

### 6.7 Leave Management

- Leave types and policies per tenant
- Employee leave requests with attachments
- Manager approval workflow (approve/reject)
- Approved leave must integrate with attendance processing

### 6.8 Overtime (OT)

- OT calculation rules configurable:
  - multipliers by weekday/weekend/holiday
  - rounding rules (e.g., 15/30 minutes)
- OT approval required for payroll eligibility (manager approval)

### 6.9 Payroll & Payslips

- Salary structures per employee:
  - base salary, allowances, deductions, taxes (configurable components)
- Payroll run per period:
  - preview → validate → finalize flow
  - finalized runs locked (controlled reopen with audit)
- Attendance-based adjustments:
  - absence deductions
  - late penalties (slab-based or minute-based)
  - OT payments
- Payslips:
  - PDF download
  - history archive for employees
  - bulk generation and bulk export (role-restricted)

### 6.10 Reporting & Exports

- Attendance reports:
  - daily summary, late list, absence list, OT list
- Payroll reports:
  - preview report, finalized summary
- Export formats:
  - CSV/Excel

### 6.11 Notifications

- Email/SMS (configurable channels):
  - device offline
  - pending approvals
  - payroll finalized
  - sync failures

---

## 7. Functional Requirements (Superadmin)

- Create tenant (with Cloudflare provisioning)
- Suspend/reactivate tenant
- View tenant provisioning status and retry provisioning
- Platform health dashboard:
  - job/worker status
  - failure rates for provisioning and device sync

---

## 8. UI/UX Requirements (React + Beautiful UI)

### 8.1 Quality Bar

- Clean modern UI with consistent typography and spacing
- Responsive (desktop + mobile)
- Light and dark theme
- Loading skeletons, empty states, and error states
- Accessible interactions (keyboard navigation and focus visibility)

### 8.2 Tenant Portal Screens (Minimum)

- Auth: login, forgot password, invitation acceptance
- Dashboard: today summary, devices offline, pending approvals
- Employees
- Devices (“Machines”)
- Shifts/Rosters
- Attendance: list + calendar, correction workflow with audit visibility
- Leave: requests + approvals
- Payroll: salary setup, payroll run preview/finalize
- Payslips: view/download/history
- Settings: company profile, roles, calendars

### 8.3 Superadmin Screens (Minimum)

- Tenants list + create tenant
- Provisioning logs and retry actions
- Platform health and job status

---

## 9. Security Requirements (Mandatory)

### 9.1 Authentication

- Strong password hashing using PHP built-ins (bcrypt/argon2)
- Rate limit login attempts
- Password reset with signed, expiring tokens

### 9.2 Authorization & Tenant Isolation

- Enforce tenant boundary for every request (hostname-based tenant resolution)
- Prevent IDOR by validating resource ownership within tenant

### 9.3 Web Security

- HTTPS only
- Prepared statements for all DB queries
- CSRF protection for state-changing requests if using cookie sessions
- Strict CORS policy (only known origins)
- File upload restrictions:
  - allowlist types, size limits, store outside web root

### 9.4 Secrets Handling

- Cloudflare token stored only server-side
- No secrets in frontend bundle or logs
- Sensitive fields (e.g., device credentials) protected at rest

### 9.5 Audit Logging

- Audit log for:
  - tenant provisioning actions
  - manual attendance overrides
  - payroll finalization and exports

---

## 10. Non-functional Requirements

- Availability: 99.9% uptime target for tenant portals
- Performance:
  - process 1 day of events for 5,000 employees within 15 minutes baseline
- Scalability:
  - many tenants concurrently without cross-tenant impact
- Backup & retention:
  - daily backups
  - raw events retention configurable (default 1 year)
- Observability:
  - health checks, job status visibility, alerting on failures

---

## 11. Data Model (High-level)

All tenant-owned tables include `tenant_id`.

- Tenant: id, subdomain, status, created_at
- TenantUser: id, tenant_id, email, password_hash, role, status
- Employee: id, tenant_id, employee_code, name, department_id, designation_id, status
- Site: id, tenant_id, name
- Device: id, tenant_id, site_id, name, model, ip_or_host, status, last_sync_at
- RawEvent: id, tenant_id, device_id, occurred_at_utc, identifier, event_type, raw_payload
- Shift: id, tenant_id, name, start_time, end_time, grace_minutes, breaks
- RosterAssignment: id, tenant_id, employee_id, date, shift_id
- AttendanceDay: id, tenant_id, employee_id, date, in_time, out_time, worked_minutes, late_minutes, ot_minutes, status
- LeaveRequest: id, tenant_id, employee_id, start_date, end_date, type, status
- PayrollRun: id, tenant_id, month, year, status, finalized_at
- Payslip: id, tenant_id, payroll_run_id, employee_id, earnings_json, deductions_json, net_pay
- AuditLog: id, tenant_id(nullable), actor_user_id, action, meta_json, created_at

---

## 12. Acceptance Criteria (Must Pass)

1. Creating a tenant provisions DNS via Cloudflare and activates the tenant.
2. Tenant A cannot access Tenant B data under any condition.
3. A tenant can register multiple devices across sites and sync independently.
4. Duplicate device events do not create duplicate attendance days.
5. Only payroll roles can finalize payroll and export payslips in bulk.
6. Provisioning retry does not create duplicate Cloudflare DNS records.
